user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    ##
    # Logs
    ##
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '"$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log main;
    error_log   /var/log/nginx/error.log warn;

    ##
    # Básicos
    ##
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    server_tokens off;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    ##
    # Compresión
    ##
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        application/x-javascript
        text/javascript
        application/xml
        text/xml
        image/svg+xml;

    ##
    # Para WebSockets / Upgrade
    ##
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    ##
    # Upstreams a servicios en el HOST Windows (acceso desde el contenedor)
    ##
    upstream modelo_api      { server host.docker.internal:8000; }
    upstream auth_sso_api    { server host.docker.internal:7100; }
    upstream login_api       { server host.docker.internal:7000; }
    upstream adduser_api     { server host.docker.internal:7070; }
    upstream chatdoc_api     { server host.docker.internal:8100; }
    upstream nlp_api         { server host.docker.internal:5000; }
    upstream comparador_api  { server host.docker.internal:8007; }
    upstream websearch_api   { server host.docker.internal:8200; }
    upstream legalsearch_api { server host.docker.internal:8300; }
    upstream insights_api { server host.docker.internal:8009; }


    ##
    # Bus / servidor Cosmos MCP real
    ##
    upstream cosmos_mcp_api  { server host.docker.internal:8090; }

    # ==========================================================
    #Primario: gpt-oss (2 llama-server: GPU0:8003, GPU1:8004)
    #  max_conns fuerza "degradación" cuando hay mucha concurrencia.
    #  zone hace que el límite sea compartido por workers. :contentReference[oaicite:2]{index=2}
    # ==========================================================
    upstream llama_oss_api {
        least_conn;

        zone llama_oss_api 64k;

        # Ajusta max_conns (explicación abajo)
        server host.docker.internal:8003 max_conns=16 max_fails=2 fail_timeout=10s;
        server host.docker.internal:8004 max_conns=16 max_fails=2 fail_timeout=10s;

        keepalive 32;
    }

    # ==========================================================
    #Fallback: Qwen3-14B (2 llama-server: GPU0:8013, GPU1:8014)
    # ==========================================================
    upstream qwen_14b_api {
        least_conn;

        zone qwen_14b_api 64k;

        server host.docker.internal:8013 max_fails=2 fail_timeout=10s;
        server host.docker.internal:8014 max_fails=2 fail_timeout=10s;

        keepalive 32;
    }

    ##
    # HTTP → redirección a HTTPS
    ##
    server {
        listen      80;
        server_name cosmos.cosgs.int;

        return 301 https://$host$request_uri;
    }

    # ==========================================================
    #OPCIONAL: endpoint local sin SSL para /v1 (mantener 8002)
    # ==========================================================
    server {
        listen 8002;
        server_name _;

        client_max_body_size 50M;

        location ^~ /v1/ {
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 10s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            #Si el primario está saturado (max_conns) o falla, cae a Qwen. :contentReference[oaicite:3]{index=3}
            proxy_intercept_errors on;
            error_page 502 503 504 = @qwen_fallback_8002;

            proxy_pass http://llama_oss_api;

            add_header X-Upstream    $upstream_addr always;
            add_header X-LLM-Backend gpt-oss always;
        }

        location @qwen_fallback_8002 {
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 10s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            proxy_pass http://qwen_14b_api;

            add_header X-Upstream    $upstream_addr always;
            add_header X-LLM-Backend qwen-14b always;
        }

        location = /nginx_status {
            stub_status;
            access_log off;

            # Permite localhost y rangos típicos docker; evita exponerlo “a internet”
            allow 127.0.0.1;
            # allow 10.0.0.0/8;
            # allow 172.16.0.0/12;
            # allow 192.168.0.0/16;
            # deny all;
        }

    }

    ##
    # Servidor principal HTTPS
    ##
    server {
        listen      443 ssl;
        server_name cosmos.cosgs.int;

        # Certificados (ajusta rutas/nombres)
        ssl_certificate     /etc/nginx/certs/cosmos.cosgs.int.crt;
        ssl_certificate_key /etc/nginx/certs/cosmos.cosgs.int.key;

        # Tamaño máximo de subida
        client_max_body_size 50M;

        # Cabeceras de seguridad
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), interest-cohort=()" always;

        # ROOT del frontend React
        root   /var/www/frontend/build;
        index  index.html;

        # Estáticos fingerprinted (cacheables)
        location /static/ {
            access_log off;
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri $uri/ =404;
        }

        location /assets/ {
            access_log off;
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri $uri/ =404;
        }


        location = /process_meets {
            proxy_http_version 1.1;

            proxy_set_header Connection "";
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Si tu endpoint necesita auth/bearer, preserva Authorization
            proxy_set_header Authorization      $http_authorization;

            # Para payloads grandes y streaming estable
            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 10s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            # Mapea EXACTO al endpoint interno
            proxy_pass http://insights_api/v1/insights/analyze_vexa;
        }
        
        # ==========================================================
        #API OpenAI-compatible /v1/* -> primario con fallback
        # ==========================================================
        location ^~ /v1/ {
            proxy_http_version 1.1;

            proxy_set_header Connection "";
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 10s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            #Si el primario está saturado o falla, cae a Qwen. :contentReference[oaicite:4]{index=4}
            proxy_intercept_errors on;
            error_page 502 503 504 = @qwen_fallback_443;

            proxy_pass http://llama_oss_api;

            add_header X-Upstream    $upstream_addr always;
            add_header X-LLM-Backend gpt-oss always;
        }

        location @qwen_fallback_443 {
            proxy_http_version 1.1;

            proxy_set_header Connection "";
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 10s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            proxy_pass http://qwen_14b_api;

            add_header X-Upstream    $upstream_addr always;
            add_header X-LLM-Backend qwen-14b always;
        }

        # ======================
        #  LOGIN FRONTAL
        # ======================
        location = /login {
            proxy_pass         http://login_api;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Logout global via SSO
        location = /logout {
            proxy_pass         http://auth_sso_api/auth/logout;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect http://localhost:7100/auth/ $scheme://$host/api/auth/;
        }

        # ======================
        #  CAPA MCP
        # ======================
        location = /api/v1/mcp {
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 5s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            proxy_set_header Upgrade            $http_upgrade;
            proxy_set_header Connection         $connection_upgrade;

            proxy_pass http://cosmos_mcp_api/mcp;
        }

        location ^~ /api/v1/mcp/ {
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 5s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            proxy_set_header Upgrade            $http_upgrade;
            proxy_set_header Connection         $connection_upgrade;

            proxy_pass http://cosmos_mcp_api/mcp/;
        }

        location ^~ /mcp {
            proxy_pass         http://cosmos_mcp_api;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization      $http_authorization;

            proxy_buffering off;
            proxy_request_buffering off;
            chunked_transfer_encoding on;

            proxy_connect_timeout 5s;
            proxy_read_timeout    3600s;
            proxy_send_timeout    3600s;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
        }

        # ======================
        #  API MODELO NEGOCIO
        # ======================
        location /api/modelo/ {
            proxy_pass         http://modelo_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_connect_timeout 5s;
            proxy_read_timeout    300s;
            proxy_send_timeout    300s;
        }

        # ======================
        #  API CHAT DOCUMENT
        # ======================
        location /api/chatdoc/ {
            proxy_pass         http://chatdoc_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_connect_timeout 5s;
            proxy_read_timeout    300s;
            proxy_send_timeout    300s;
        }

        # ======================
        #  API NLP / RAG
        # ======================
        location /api/nlp/ {
            proxy_pass         http://nlp_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_connect_timeout 5s;
            proxy_read_timeout    600s;
            proxy_send_timeout    600s;
        }

        # ======================
        #  API COMPARADOR
        # ======================
        location /api/comparador/ {
            proxy_pass         http://comparador_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_connect_timeout 5s;
            proxy_read_timeout    600s;
            proxy_send_timeout    600s;
        }

        # ======================
        #  API AUTH SSO (Entra)
        # ======================
        location /api/auth/ {
            proxy_pass         http://auth_sso_api/auth/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_redirect http://localhost:7100/auth/ $scheme://$host/api/auth/;
        }

        # ======================
        #  INTEGRACIÓN NOTETAKER (SSO URL)
        # ======================
        location = /api/notetaker/sso-url {
            proxy_pass         http://modelo_api/integrations/notetaker/sso-url;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Preserva auth/cookies para sesión + CSRF
            proxy_set_header Authorization      $http_authorization;
            proxy_set_header Cookie             $http_cookie;

            # Respuesta no cacheable (backend ya lo marca, pero reforzamos)
            add_header Cache-Control "no-store" always;

            proxy_connect_timeout 5s;
            proxy_read_timeout    30s;
            proxy_send_timeout    30s;
        }


        # ======================
        #  API LOGIN clásico
        # ======================
        location /api/login/ {
            proxy_pass         http://login_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect http://localhost:7000/ $scheme://$host/api/login/;
        }

        # ======================
        #  API ALTA USUARIOS
        # ======================
        location /api/adduser/ {
            proxy_pass         http://adduser_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ======================
        #  API BÚSQUEDA WEB AVANZADA
        # ======================
        location /api/websearch/ {
            proxy_pass         http://websearch_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_connect_timeout 5s;
            proxy_read_timeout    300s;
            proxy_send_timeout    300s;
        }

        # ======================
        #  API EXPLORACION LEGAL AVANZADA
        # ======================
        location /api/legalsearch/ {
            proxy_pass         http://legalsearch_api/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            proxy_connect_timeout 5s;
            proxy_read_timeout    300s;
            proxy_send_timeout    300s;
        }

        # Health de Nginx
        location = /health {
            add_header Content-Type application/json;
            return 200 '{"status":"ok","component":"nginx"}';
        }

        # Fallback SPA para React Router
        location / {
            try_files $uri /index.html;
        }
    }
}
